<template>
    <lightning-card title={cardTitle} icon-name={cardIcon} class="slds-var-p-around_small">

        <div slot="actions">
            <!-- REFRESH COMPONENT -->
            <lightning-button-icon 
                slot="actions" 
                icon-name="utility:refresh"  
                alternative-text="Refresh Component" 
                title="Refresh"
                onclick={handleRefreshData}
            ><label></label>
            </lightning-button-icon>
            <!-- ADD NEW SET -->
            <lightning-button 
                variant="brand-outline" 
                label="Add New Future Set" 
                title="Add New Future Set" 
                onclick={handleNewFutureSet} 
                class="slds-var-m-left_x-small"
            ></lightning-button>
        </div>

        <template if:true={showModal}>
            <c-fsl-future-allocation-editor 
                opportunity-id={recordId} 
                allocation-set-id={selectedSetId} 
                allocation-set-date={selectedSetDate} 
                future-allocations={selectedSetAllocations} 
                onclose={handleToggleModal} 
                onrefresh={handleRefreshData}
            >
            </c-fsl-future-allocation-editor>
        </template>

        <!-- CREATE NEW FUTURE ALLOCATION SETS -->
        <template if:true={isAddingFutureSet}>
            <lightning-layout vertical-align="center">
                <lightning-layout-item flexibility="auto" padding="around-small" class="slds-size_6-of-12">
                    <lightning-input 
                        type="date" 
                        name="effective-date" 
                        label="Effective Date" 
                        class="slds-var-p-around_medium" 
                        onchange={handleFieldChange}
                    ></lightning-input>
                </lightning-layout-item>
                <lightning-layout-item flexibility="auto" padding="around-small" class="slds-size_6-of-12">
                    <lightning-button 
                        variant="sucess" 
                        label="Save" 
                        title="Save" 
                        onclick={handleSubmit} 
                    ></lightning-button>
                    <lightning-button 
                        variant="destructive-outline" 
                        label="Cancel" 
                        title="Cancel" 
                        onclick={handleCancel} 
                        class="slds-var-m-left_x-small"
                    ></lightning-button>
                </lightning-layout-item>
            </lightning-layout>
        </template>

        <!-- DISPLAY EXISTING FUTURE ALLOCATION SETS -->
        <lightning-accordion 
            allow-multiple-sections-open
            onsectiontoggle={handleSectionToggle}
            active-section-name={activeSections}>
            <template for:each={futureAllocationSets} for:item="set">
                <lightning-accordion-section name={set.Id} label={set.formattedName} key={set.Id}>
                    <!-- SECTION LEVEL ACTIONS -->
                    <lightning-button-menu slot="actions" alternative-text="Show menu" data-record-id={set.Id} icon-size="x-small" menu-alignment="auto" onselect={handleMenuSelect}>
                        <lightning-menu-item value="edit" icon-name="action:edit" label="Edit"></lightning-menu-item>
                        <lightning-menu-item value="delete" icon-name="action:delete" label="TODO - Delete"></lightning-menu-item>
                    </lightning-button-menu>

                    <!-- ALLOCATION DATATABLE -->
                    <div>
                        <lightning-datatable
                            data={set.Future_Allocations__r} 
                            columns={cols} 
                            key-field="Id" 
                            column-widths-mode="auto" 
                            hide-checkbox-column 
                            onrowaction={handleRowAction}
                        ></lightning-datatable>
                    </div>

                </lightning-accordion-section>
            </template>
        </lightning-accordion>

    </lightning-card>
</template>